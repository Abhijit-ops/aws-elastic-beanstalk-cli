#!/bin/bash

# Check for arguments
if [ $1 ]; then
    if [ $1 = '--help' ]; then
		printf "Usage: install-ebcli.sh [--version {version}]]\nInstalls awsebcli in a virtual env. \n'"
		exit 1
    elif [ $1 = '--version' ]; then
        version="==$2"
        #echo $version
    else
        echo "Invalid option. Use the --help option for usage."
		exit 1
    fi
fi

# Install virtualenv if needed
if [ ! -d ~/.ebvenv ]; then
    curl -o - https://s3.amazonaws.com/elasticbeanstalk-cli-resources/get-pip.py | python - --user
    python -m pip install -U virtualenv --user
    python -m virtualenv ~/.ebvenv
fi

# Do install
source ~/.ebvenv/bin/activate
python -m pip install -U awsebcli$version
deactivate
    
# Set up link to shell script
versioncheck=$(~/.ebvenv/bin/eb --version)
status="$?"
if [ $status = "0" ]; then
    echo "EB CLI Successfully installed."
    echo "==> setting up link.."
    sudo mkdir -p /usr/local/bin
    error="false"
    status="$?"
    if [ $status != "0" ]; then
        error=true
    fi
    if [ $error = "true" ] && [ ! -L /usr/local/bin/eb ]; then
        sudo ln -s ~/.ebvenv/bin/eb /usr/local/bin/eb
        sudo ln -s ~/.ebvenv/bin/ebp /usr/local/bin/ebp
        status="$?"
        if [ $status != "0" ]; then
            error="true"
        fi
    fi
    if [ $error = "true" ]; then
        echo "Error setting up link to /usr/local/bin. Add 'alias eb=~/.ebvenv/bin/eb' to your profile."
    fi
    else
        echo "done."
else
    echo "Error: Something went wrong during installation."
fi
